<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ACE Architecture Demo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ─── Reset ─────────────────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; }

    /* ─── Root layout: strict 50/50 split ───────────────────────────── */
    #app {
      display: flex;
      width: 100vw;
      height: 100vh;
    }

    /* ════════════════════════════════════════════════════════════════
       LEFT PANEL — white, architecture diagram
    ════════════════════════════════════════════════════════════════ */
    #left {
      width: 50%;
      height: 100vh;
      background: #ffffff;
      border-right: 1px solid #E8E8E8;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      overflow: hidden;
    }

    /* Run Demo button row */
    #btn-row {
      flex-shrink: 0;
      display: flex;
      justify-content: center;
      padding: 20px 0 0;
    }

    #runDemoBtn {
      background: #00897B;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 28px;
      font-size: 14px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      letter-spacing: 0.015em;
      transition: background 0.18s, box-shadow 0.18s;
    }
    #runDemoBtn:hover   { background: #00796B; box-shadow: 0 4px 20px rgba(0,137,123,0.36); }
    #runDemoBtn:active  { background: #00695C; }
    #runDemoBtn:disabled { background: #80CBC4; cursor: not-allowed; box-shadow: none; }

    /* Diagram fills remaining height */
    #diagram {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-evenly;
      padding: 10px 16px 14px;
      min-height: 0;
    }

    /* Arrow overlay — sits behind boxes */
    #arrows {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: visible;
    }

    /* ─── Layer group ─────────────────────────────────────────────── */
    .layer {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .layer-label {
      font-size: 11px;
      font-weight: 600;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
      white-space: nowrap;
    }

    .row {
      display: flex;
      gap: 6px;
      width: 100%;
    }

    .row + .row { margin-top: 18px; }

    /* ─── Box ─────────────────────────────────────────────────────── */
    .box {
      flex: 1;
      min-width: 0;
      background: #F7F7F7;
      border: 1.5px solid #D0D0D0;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      padding: 8px 6px;
      min-height: 42px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: border-color 0.28s, box-shadow 0.28s, background 0.28s;
    }

    .box span.lbl {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      line-height: 1.3;
      transition: color 0.28s;
    }

    .box span.tag {
      display: block;
      font-size: 8.5px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: #C0C0C0;
      margin-top: 3px;
    }

    /* Left-border accents */
    .teal  { border-left: 3px solid #00897B; }
    .blue  { border-left: 3px solid #1E88E5; }
    .amber { border-left: 3px solid #F59E0B; }

    /* Sunset / deprecated style */
    .sunset          { border: 1.5px dashed #CCCCCC !important; }
    .sunset span.lbl { color: #AAAAAA; font-style: italic; }

    /* Active highlight (used by demo runner) */
    .box.active {
      border-color: #00897B !important;
      border-width: 2px !important;
      background: #E8F5E9 !important;
      box-shadow: 0 0 0 3px rgba(0,137,123,0.18), 0 2px 8px rgba(0,0,0,0.10);
    }
    .box.active span.lbl { color: #00695C; }

    /* ════════════════════════════════════════════════════════════════
       RIGHT PANEL — dramatic sky aesthetic + floating chat widget
    ════════════════════════════════════════════════════════════════ */
    #right {
      width: 50%;
      height: 100vh;
      position: relative;
      overflow: hidden;
    }

    /* Gradient sky: bright top → deep dark bottom */
    #sky-grad {
      position: absolute; inset: 0;
      background: linear-gradient(to bottom,
        #4A90D9  0%,
        #2E68B8 22%,
        #1B3A6B 52%,
        #0D2045 76%,
        #0A1628 100%
      );
    }

    /* Upper atmospheric scattering haze */
    #sky-haze {
      position: absolute; inset: 0;
      background: radial-gradient(ellipse 130% 45% at 50% 0%,
        rgba(120,190,255,0.13) 0%, transparent 70%);
      pointer-events: none;
    }

    /* Warm horizon glow ~60% from top */
    #horizon {
      position: absolute;
      top: 60%; left: -25%; right: -25%; height: 120px;
      transform: translateY(-50%);
      background: radial-gradient(ellipse 80% 60px at 50% 50%,
        rgba(255,244,200,0.21) 0%, rgba(255,224,150,0.10) 45%, transparent 100%);
      pointer-events: none;
    }

    .sky-svg {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }

    /* ════════════════════════════════════════════════════════════════
       CHAT WIDGET — floating, bottom-right
    ════════════════════════════════════════════════════════════════ */
    #chat-widget {
      position: absolute;
      bottom: 24px;
      right: 24px;
      width: 360px;
      max-height: 520px;
      background: #FFFFFF;
      border-radius: 16px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.28);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 10;
    }

    /* Header */
    #chat-header {
      background: #00897B;
      padding: 13px 16px;
      border-radius: 16px 16px 0 0;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    #chat-header-title {
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      letter-spacing: 0.01em;
    }

    /* Online status dot */
    #chat-status {
      width: 8px;
      height: 8px;
      background: #A5D6A7;
      border-radius: 50%;
      margin-left: auto;
      flex-shrink: 0;
      box-shadow: 0 0 0 2px rgba(165,214,167,0.35);
    }

    /* Messages area */
    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
      scroll-behavior: smooth;
    }

    #chat-messages::-webkit-scrollbar        { width: 4px; }
    #chat-messages::-webkit-scrollbar-track  { background: transparent; }
    #chat-messages::-webkit-scrollbar-thumb  { background: #E0E0E0; border-radius: 2px; }

    /* Empty state */
    #chat-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 160px;
      color: #BDBDBD;
      font-size: 12px;
      font-family: 'Inter', sans-serif;
      text-align: center;
      gap: 10px;
      padding: 20px;
      user-select: none;
    }
    #chat-empty strong { color: #9E9E9E; font-weight: 600; }

    /* Chat bubbles */
    .bubble {
      max-width: 75%;
      padding: 10px 14px;
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      line-height: 1.5;
      word-break: break-word;
      opacity: 0;
      transform: translateY(6px);
      animation: bubbleIn 0.22s ease forwards;
    }

    @keyframes bubbleIn {
      to { opacity: 1; transform: translateY(0); }
    }

    .bubble-user {
      align-self: flex-end;
      background: #00897B;
      color: #fff;
      border-radius: 12px 12px 2px 12px;
    }

    .bubble-assistant {
      align-self: flex-start;
      background: #F1F3F4;
      color: #333;
      border-radius: 12px 12px 12px 2px;
    }

    /* Typing indicator */
    .typing-indicator {
      align-self: flex-start;
      background: #F1F3F4;
      border-radius: 12px 12px 12px 2px;
      padding: 12px 16px;
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .typing-dot {
      width: 7px;
      height: 7px;
      background: #AAAAAA;
      border-radius: 50%;
      animation: typingBounce 1.1s infinite ease-in-out;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.18s; }
    .typing-dot:nth-child(3) { animation-delay: 0.36s; }

    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0);    opacity: 0.5; }
      30%            { transform: translateY(-5px); opacity: 1;   }
    }

    /* Footer / decorative input bar */
    #chat-footer {
      flex-shrink: 0;
      padding: 10px 12px;
      border-top: 1px solid #EBEBEB;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    #chat-input {
      flex: 1;
      height: 36px;
      border: 1.5px solid #E0E0E0;
      border-radius: 8px;
      padding: 0 12px;
      font-size: 13px;
      font-family: 'Inter', sans-serif;
      color: #BDBDBD;
      background: #FAFAFA;
      cursor: not-allowed;
      outline: none;
    }

    #chat-send {
      height: 36px;
      padding: 0 16px;
      background: #00897B;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      cursor: not-allowed;
      opacity: 0.7;
      letter-spacing: 0.01em;
    }
  </style>
</head>
<body>
<div id="app">

  <!-- ══════════════════════════════════════════════════════════
       LEFT PANEL — architecture diagram
  ══════════════════════════════════════════════════════════════ -->
  <div id="left">

    <div id="btn-row">
      <button id="runDemoBtn">&#9654; Run Demo</button>
    </div>

    <div id="diagram">

      <!-- Arrows drawn by JS into this SVG -->
      <svg id="arrows"></svg>

      <!-- ╔══════════════════════════════════════╗
           ║  LAYER 1 — INPUTS & TOUCHPOINTS      ║
           ╚══════════════════════════════════════╝ -->
      <div class="layer">
        <div class="layer-label">Inputs &amp; Touchpoints</div>
        <div class="row">
          <div class="box teal"  id="node-satair-market">
            <span class="lbl">Satair Market</span>
          </div>
          <div class="box blue"  id="node-self-service-portal">
            <span class="lbl">Self-Service Portal</span>
          </div>
          <div class="box"       id="node-email-intake">
            <span class="lbl">Email Intake</span>
          </div>
          <div class="box teal"  id="node-ai-case-management">
            <span class="lbl">AI Case Management</span>
          </div>
          <div class="box teal"  id="node-human-in-the-loop">
            <span class="lbl">Human in the Loop</span>
          </div>
        </div>
      </div>

      <!-- ╔══════════════════════════════════════╗
           ║  LAYER 2 — AI ORCHESTRATION          ║
           ╚══════════════════════════════════════╝ -->
      <div class="layer">
        <div class="layer-label">AI Orchestration</div>
        <div class="row">
          <div class="box amber" id="node-session-manager">
            <span class="lbl">Session Manager</span>
          </div>
          <div class="box amber" id="node-ace-ai-orchestrator">
            <span class="lbl">ACE AI Orchestrator</span>
          </div>
          <div class="box amber" id="node-llm-service">
            <span class="lbl">LLM Service</span>
          </div>
        </div>
        <div class="row">
          <div class="box amber" id="node-session-state">
            <span class="lbl">Session State</span>
          </div>
          <div class="box amber" id="node-ticket-tool">
            <span class="lbl">Ticket Tool</span>
          </div>
          <div class="box amber" id="node-sap-lookup-tool">
            <span class="lbl">SAP Lookup Tool</span>
          </div>
          <div class="box amber" id="node-knowledge-tool">
            <span class="lbl">Knowledge Tool</span>
          </div>
          <div class="box amber" id="node-case-history-tool">
            <span class="lbl">Case History Tool</span>
          </div>
          <div class="box amber" id="node-response-draft-tool">
            <span class="lbl">Response Draft Tool</span>
          </div>
        </div>
      </div>

      <!-- ╔══════════════════════════════════════╗
           ║  LAYER 3 — INTEGRATION LAYER         ║
           ╚══════════════════════════════════════╝ -->
      <div class="layer">
        <div class="layer-label">Integration Layer</div>
        <div class="row">
          <div class="box"        id="node-case-management-adapter">
            <span class="lbl">Case Management Adapter</span>
          </div>
          <div class="box"        id="node-sap-adapters">
            <span class="lbl">SAP Adapters</span>
          </div>
          <div class="box"        id="node-knowledge-doc-adapters">
            <span class="lbl">Knowledge &amp; Doc Adapters</span>
          </div>
          <div class="box sunset" id="node-llm-adapter">
            <span class="lbl">LLM Adapter</span>
            <span class="tag">sunset</span>
          </div>
          <div class="box sunset" id="node-legacy-automation">
            <span class="lbl">Legacy Automation</span>
            <span class="tag">sunset</span>
          </div>
        </div>
      </div>

      <!-- ╔══════════════════════════════════════╗
           ║  LAYER 4 — CORE SYSTEMS              ║
           ╚══════════════════════════════════════╝ -->
      <div class="layer">
        <div class="layer-label">Core Systems</div>
        <div class="row">
          <div class="box"        id="node-freshdesk">
            <span class="lbl">Freshdesk</span>
          </div>
          <div class="box"        id="node-sap-rpr">
            <span class="lbl">SAP-RPR</span>
          </div>
          <div class="box"        id="node-sap-ap1">
            <span class="lbl">SAP-AP1</span>
          </div>
          <div class="box"        id="node-sap-cc">
            <span class="lbl">SAP-CC</span>
          </div>
          <div class="box"        id="node-symbio">
            <span class="lbl">Symbio</span>
          </div>
          <div class="box sunset" id="node-lilly">
            <span class="lbl">LILLY</span>
            <span class="tag">to be replaced</span>
          </div>
        </div>
      </div>

    </div><!-- /#diagram -->
  </div><!-- /#left -->

  <!-- ══════════════════════════════════════════════════════════
       RIGHT PANEL — dramatic sky aesthetic + chat widget
  ══════════════════════════════════════════════════════════════ -->
  <div id="right">
    <div id="sky-grad"></div>
    <div id="sky-haze"></div>
    <div id="horizon"></div>

    <!-- Wing shapes: large, sweeping semi-transparent white curves -->
    <svg class="sky-svg" viewBox="0 0 800 900"
         preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg">
      <!-- Main wing body -->
      <path d="M -100,880 C 100,680 380,590 940,540 L 940,620 C 380,670 100,760 -100,960 Z"
            fill="rgba(255,255,255,0.055)"/>
      <!-- Secondary wing layer -->
      <path d="M -100,760 C 140,580 440,505 960,458 L 960,520 C 440,568 140,643 -100,824 Z"
            fill="rgba(255,255,255,0.042)"/>
      <!-- Leading-edge highlight -->
      <path d="M -100,785 C 190,615 490,548 970,500"
            stroke="rgba(255,255,255,0.17)" stroke-width="1.4" fill="none"/>
      <path d="M -100,840 C 240,675 510,612 970,566"
            stroke="rgba(255,255,255,0.07)" stroke-width="0.9" fill="none"/>
      <!-- Upper winglet sweeping from top-right -->
      <path d="M 560,0 C 625,75 680,185 715,330 C 740,430 750,520 755,600
               L 740,604 C 734,524 724,434 699,334 C 663,190 608,80 545,6 Z"
            fill="rgba(255,255,255,0.055)"/>
      <path d="M 660,0 C 710,65 748,160 770,290 C 785,375 790,455 792,520
               L 779,522 C 777,457 772,378 756,294 C 734,165 695,71 647,8 Z"
            fill="rgba(255,255,255,0.038)"/>
      <path d="M 570,0 C 640,90 695,220 728,380 C 745,460 752,540 755,610"
            stroke="rgba(255,255,255,0.14)" stroke-width="1" fill="none"/>
      <!-- Contrail lines -->
      <line x1="-60" y1="258" x2="970" y2="192"
            stroke="rgba(255,255,255,0.10)" stroke-width="1"/>
      <line x1="-60" y1="274" x2="970" y2="208"
            stroke="rgba(255,255,255,0.055)" stroke-width="0.7"/>
      <!-- Cloud wisps -->
      <ellipse cx="100" cy="72" rx="175" ry="21"
               fill="rgba(255,255,255,0.045)" transform="rotate(-6,100,72)"/>
      <ellipse cx="145" cy="98" rx="108" ry="13"
               fill="rgba(255,255,255,0.030)" transform="rotate(-6,145,98)"/>
      <ellipse cx="440" cy="185" rx="215" ry="16"
               fill="rgba(255,255,255,0.028)" transform="rotate(-3,440,185)"/>
      <!-- Sunray shafts -->
      <polygon points="400,320 -20,75 65,75"  fill="rgba(255,240,185,0.020)"/>
      <polygon points="400,320 800,55 718,55" fill="rgba(255,240,185,0.016)"/>
    </svg>

    <!-- Sparse star field (upper region) -->
    <svg class="sky-svg" viewBox="0 0 800 900"
         preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg">
      <circle cx="52"  cy="36"  r="1.0" fill="rgba(255,255,255,0.68)"/>
      <circle cx="178" cy="17"  r="1.2" fill="rgba(255,255,255,0.58)"/>
      <circle cx="308" cy="53"  r="0.8" fill="rgba(255,255,255,0.72)"/>
      <circle cx="492" cy="27"  r="1.0" fill="rgba(255,255,255,0.52)"/>
      <circle cx="638" cy="46"  r="0.9" fill="rgba(255,255,255,0.62)"/>
      <circle cx="748" cy="13"  r="1.1" fill="rgba(255,255,255,0.47)"/>
      <circle cx="92"  cy="123" r="0.8" fill="rgba(255,255,255,0.44)"/>
      <circle cx="262" cy="103" r="1.0" fill="rgba(255,255,255,0.50)"/>
      <circle cx="428" cy="88"  r="0.7" fill="rgba(255,255,255,0.55)"/>
      <circle cx="584" cy="116" r="1.0" fill="rgba(255,255,255,0.44)"/>
      <circle cx="702" cy="86"  r="0.9" fill="rgba(255,255,255,0.52)"/>
      <circle cx="762" cy="152" r="0.7" fill="rgba(255,255,255,0.40)"/>
      <circle cx="38"  cy="194" r="0.8" fill="rgba(255,255,255,0.37)"/>
      <circle cx="348" cy="158" r="0.7" fill="rgba(255,255,255,0.40)"/>
    </svg>

    <!-- ── Chat Widget ───────────────────────────────────────────── -->
    <div id="chat-widget">

      <div id="chat-header">
        <!-- Bot icon: robot head + speech bubble indicator -->
        <svg width="28" height="28" viewBox="0 0 28 28" fill="none"
             xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <!-- Antenna -->
          <line x1="14" y1="4.2" x2="14" y2="2"
                stroke="rgba(255,255,255,0.88)" stroke-width="1.4" stroke-linecap="round"/>
          <circle cx="14" cy="1.2" r="1.2" fill="rgba(255,255,255,0.88)"/>
          <!-- Head -->
          <rect x="7" y="4.8" width="14" height="11" rx="3.5"
                fill="rgba(255,255,255,0.92)"/>
          <!-- Eyes -->
          <circle cx="11" cy="10.3" r="1.4" fill="#00897B"/>
          <circle cx="17" cy="10.3" r="1.4" fill="#00897B"/>
          <!-- Smile -->
          <path d="M 11 13 Q 14 14.8 17 13"
                stroke="#00897B" stroke-width="1" fill="none" stroke-linecap="round"/>
          <!-- Body / speech bubble -->
          <rect x="6" y="18" width="16" height="8" rx="3"
                fill="rgba(255,255,255,0.72)"/>
          <path d="M 10.5 26 L 8.5 28.5 L 14 26 Z"
                fill="rgba(255,255,255,0.72)"/>
          <!-- Dots in body -->
          <circle cx="10" cy="22" r="1.1" fill="#00897B" opacity="0.55"/>
          <circle cx="14" cy="22" r="1.1" fill="#00897B" opacity="0.55"/>
          <circle cx="18" cy="22" r="1.1" fill="#00897B" opacity="0.55"/>
        </svg>
        <span id="chat-header-title">Customer Assistant</span>
        <div id="chat-status" title="Online"></div>
      </div>

      <div id="chat-messages">
        <div id="chat-empty">
          <svg width="34" height="34" viewBox="0 0 34 34" fill="none"
               xmlns="http://www.w3.org/2000/svg" opacity="0.45">
            <path d="M4 7a4 4 0 014-4h18a4 4 0 014 4v13a4 4 0 01-4 4H11l-7 4.5V7z"
                  stroke="#BDBDBD" stroke-width="1.6" fill="none" stroke-linejoin="round"/>
            <circle cx="11" cy="13.5" r="1.5" fill="#BDBDBD"/>
            <circle cx="17" cy="13.5" r="1.5" fill="#BDBDBD"/>
            <circle cx="23" cy="13.5" r="1.5" fill="#BDBDBD"/>
          </svg>
          <span>Click <strong>&#9654; Run Demo</strong> to start</span>
        </div>
      </div>

      <div id="chat-footer">
        <input id="chat-input" type="text" placeholder="Type a message…" disabled>
        <button id="chat-send" disabled>Send</button>
      </div>

    </div><!-- /#chat-widget -->

  </div><!-- /#right -->

</div><!-- /#app -->

<script>
// ══════════════════════════════════════════════════════════════════
//  ARROW DRAWING
// ══════════════════════════════════════════════════════════════════

function drawArrows() {
  const svg  = document.getElementById('arrows');
  const wrap = document.getElementById('diagram');

  svg.innerHTML = '';
  const cr = wrap.getBoundingClientRect();
  svg.setAttribute('width',   cr.width);
  svg.setAttribute('height',  cr.height);
  svg.setAttribute('viewBox', `0 0 ${cr.width} ${cr.height}`);

  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  defs.innerHTML = `
    <marker id="arr" viewBox="0 0 8 6" markerWidth="8" markerHeight="6"
            refX="8" refY="3" orient="auto" markerUnits="userSpaceOnUse">
      <polygon points="0 0, 8 3, 0 6" fill="#B0B0B0" opacity="0.75"/>
    </marker>`;
  svg.appendChild(defs);

  function box(id) {
    const el = document.getElementById(id);
    if (!el) return null;
    const r = el.getBoundingClientRect();
    const x = r.left - cr.left;
    const y = r.top  - cr.top;
    return {
      cx:    x + r.width  / 2,
      cy:    y + r.height / 2,
      top:   y,
      bot:   y + r.height,
      left:  x,
      right: x + r.width,
    };
  }

  function path(d, dashed) {
    const el = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    el.setAttribute('d', d);
    el.setAttribute('stroke', '#B0B0B0');
    el.setAttribute('stroke-width', '1.5');
    el.setAttribute('stroke-opacity', '0.5');
    el.setAttribute('fill', 'none');
    el.setAttribute('marker-end', 'url(#arr)');
    if (dashed) el.setAttribute('stroke-dasharray', '5 3');
    svg.appendChild(el);
  }

  function down(fromId, toId, dashed) {
    const a = box(fromId), b = box(toId);
    if (!a || !b) return;
    const mid = (a.bot + b.top) / 2;
    path(`M ${a.cx},${a.bot} C ${a.cx},${mid} ${b.cx},${mid} ${b.cx},${b.top}`, dashed);
  }

  function right(fromId, toId) {
    const a = box(fromId), b = box(toId);
    if (!a || !b) return;
    path(`M ${a.right},${a.cy} L ${b.left},${b.cy}`);
  }

  function bidir(aId, bId) {
    const a = box(aId), b = box(bId);
    if (!a || !b) return;
    const off = 3.5;
    path(`M ${a.right},${a.cy - off} L ${b.left},${b.cy - off}`);
    path(`M ${b.left},${b.cy + off} L ${a.right},${a.cy + off}`);
  }

  // Layer 1 → Session Manager (five-in funnel)
  ['node-satair-market', 'node-self-service-portal', 'node-email-intake',
   'node-ai-case-management', 'node-human-in-the-loop']
    .forEach(id => down(id, 'node-session-manager'));

  // Session Manager ↔ ACE AI Orchestrator
  bidir('node-session-manager', 'node-ace-ai-orchestrator');

  // ACE AI Orchestrator → LLM Service
  right('node-ace-ai-orchestrator', 'node-llm-service');

  // ACE AI Orchestrator → tool belt (fan-out)
  ['node-session-state', 'node-ticket-tool', 'node-sap-lookup-tool',
   'node-knowledge-tool', 'node-case-history-tool', 'node-response-draft-tool']
    .forEach(id => down('node-ace-ai-orchestrator', id));

  // Tools → Integration Layer
  down('node-ticket-tool',         'node-case-management-adapter');
  down('node-sap-lookup-tool',     'node-sap-adapters');
  down('node-knowledge-tool',      'node-knowledge-doc-adapters');
  down('node-case-history-tool',   'node-case-management-adapter');
  down('node-response-draft-tool', 'node-llm-adapter');

  // Adapters → Core Systems
  down('node-case-management-adapter', 'node-freshdesk');
  down('node-sap-adapters',            'node-sap-rpr');
  down('node-sap-adapters',            'node-sap-ap1');
  down('node-sap-adapters',            'node-sap-cc');
  down('node-knowledge-doc-adapters',  'node-symbio');
  down('node-llm-adapter',             'node-lilly');
  down('node-legacy-automation',       'node-freshdesk', true);
}

let _rt;
window.addEventListener('resize', () => { clearTimeout(_rt); _rt = setTimeout(drawArrows, 60); });
window.addEventListener('load', () => requestAnimationFrame(drawArrows));


// ══════════════════════════════════════════════════════════════════
//  DEMO RUNNER
// ══════════════════════════════════════════════════════════════════

const DEMO_SCRIPT = [
  {
    type: 'user',
    text: 'Hi, I need help tracking a missing aircraft part.',
    nodes: ['node-satair-market'],
    pauseAfter: 650
  },
  {
    type: 'assistant',
    text: "Of course! I'm here to help. Could you share the part number or your order reference?",
    nodes: ['node-session-manager', 'node-ace-ai-orchestrator', 'node-llm-service'],
    typingMs: 800,
    pauseAfter: 550
  },
  {
    type: 'user',
    text: 'Part number 68A003056-001. We ordered it via Satair Market last week.',
    nodes: ['node-satair-market', 'node-ai-case-management', 'node-session-state'],
    pauseAfter: 700
  },
  {
    type: 'assistant',
    text: 'Got it — looking that up in SAP right now\u2026',
    nodes: ['node-sap-lookup-tool', 'node-sap-adapters', 'node-sap-rpr'],
    typingMs: 800,
    pauseAfter: 450
  },
  {
    type: 'assistant',
    text: 'Found it! Part 68A003056-001 was shipped Feb\u00a024th. Ticket #FD-84521 created \u2014 expected arrival tomorrow.',
    nodes: ['node-ticket-tool', 'node-case-management-adapter', 'node-freshdesk'],
    typingMs: 800,
    pauseAfter: 750
  },
  {
    type: 'user',
    text: 'Perfect. Can you also confirm the invoice is in SAP-AP1?',
    nodes: ['node-self-service-portal', 'node-ace-ai-orchestrator'],
    pauseAfter: 650
  },
  {
    type: 'assistant',
    text: 'Querying SAP-AP1 now\u2026',
    nodes: ['node-sap-adapters', 'node-sap-ap1'],
    typingMs: 800,
    pauseAfter: 400
  },
  {
    type: 'assistant',
    text: "Invoice INV-2024-9832 confirmed in SAP-AP1, dated Feb\u00a022nd. I've linked it to ticket #FD-84521. Email copy dispatched!",
    nodes: ['node-response-draft-tool', 'node-knowledge-doc-adapters', 'node-human-in-the-loop'],
    typingMs: 800,
    pauseAfter: 0
  }
];

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function setHighlight(nodeIds) {
  document.querySelectorAll('.box.active').forEach(el => el.classList.remove('active'));
  nodeIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add('active');
  });
}

function addBubble(type, text) {
  const msgs = document.getElementById('chat-messages');
  const empty = document.getElementById('chat-empty');
  if (empty) empty.remove();
  const div = document.createElement('div');
  div.className = 'bubble bubble-' + type;
  div.textContent = text;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function showTyping() {
  const msgs = document.getElementById('chat-messages');
  const ind = document.createElement('div');
  ind.className = 'typing-indicator';
  ind.id = 'typing-ind';
  ind.innerHTML =
    '<div class="typing-dot"></div>' +
    '<div class="typing-dot"></div>' +
    '<div class="typing-dot"></div>';
  msgs.appendChild(ind);
  msgs.scrollTop = msgs.scrollHeight;
}

function removeTyping() {
  const el = document.getElementById('typing-ind');
  if (el) el.remove();
}

async function runDemo() {
  const btn = document.getElementById('runDemoBtn');
  btn.disabled = true;
  btn.textContent = '\u23F3 Running\u2026';

  // Reset state
  const msgs = document.getElementById('chat-messages');
  msgs.innerHTML = '';
  document.querySelectorAll('.box.active').forEach(el => el.classList.remove('active'));

  await sleep(300);

  for (const step of DEMO_SCRIPT) {
    if (step.type === 'user') {
      setHighlight(step.nodes);
      addBubble('user', step.text);
      await sleep(step.pauseAfter || 600);
    } else {
      showTyping();
      await sleep(step.typingMs || 800);
      removeTyping();
      setHighlight(step.nodes);
      addBubble('assistant', step.text);
      await sleep(step.pauseAfter || 500);
    }
  }

  // Fade out highlights after completion
  await sleep(1600);
  document.querySelectorAll('.box.active').forEach(el => el.classList.remove('active'));

  btn.disabled = false;
  btn.innerHTML = '&#9654; Replay Demo';
}

document.getElementById('runDemoBtn').addEventListener('click', runDemo);
</script>
</body>
</html>
